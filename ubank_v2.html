<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PLTT UBANK v2</title>
    <link rel="stylesheet" href="style2.css" />
  </head>
  <body>
    <!-- Header -->
    <header id="main-header">
      <div class="header-container">
        <button class="sidebar-toggle" id="sidebar-toggle">
          <svg
            width="24"
            height="24"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
          >
            <line x1="3" y1="6" x2="21" y2="6"></line>
            <line x1="3" y1="12" x2="21" y2="12"></line>
            <line x1="3" y1="18" x2="21" y2="18"></line>
          </svg>
        </button>
        <div class="logo-container">
          <a href="index.html">
            <img
              src="./logo/logo-fecredit.svg"
              alt="FECredit"
              class="logo"
            />
          </a>
        </div>

        <!-- NEW SEARCH BAR -->
        <div class="search-container">
          <input
            type="search"
            id="header-search"
            placeholder="Tìm kiếm thông tin..."
          />
          <div id="search-results-container" class="search-results"></div>
        </div>

        <div class="header-tabs">
          <div class="dropdown">
            <button class="tab-btn dropdown-toggle">PLTT</button>
            <div class="dropdown-menu">
              <a href="loan_v2.html?source=truyvan#JTVCJTIyMS4lMjBUSCVDMyU5NE5HJTIwVElOJTIwQ0hVTkclMjIlMkMlMjJUaCVDMyVCNG5nJTIwVGluJTIwQyVDMyVCNG5nJTIwVHklMjIlNUQ=" class="dropdown-item">LOAN</a>
              <a href="card_v2.html" class="dropdown-item">CARD</a>
              <a href="outbound.html" class="dropdown-item">OUTBOUND</a>
              <a href="ubank_v2.html" class="dropdown-item">UBANK</a>
            </div>
          </div>
          <button class="tab-btn pdf-link-btn" data-pdf="THONG BAO.pdf">THÔNG BÁO</button>
          <button class="tab-btn pdf-link-btn" data-pdf="XMTT.pdf" data-tab="xmtt">XMTT</button>
          <button class="tab-btn pdf-link-btn" data-pdf="QUY DINH CHUNG.pdf" data-tab="quy-dinh">QUY ĐỊNH CHUNG</button>
          <button class="tab-btn pdf-link-btn" data-pdf="KHUYEN MAI.pdf" data-tab="khuyen-mai" id="khuyen-mai-btn">
            KHUYẾN MÃI
          </button>
          <button class="tab-btn pdf-link-btn" data-pdf="CHANGE LOG.pdf" data-tab="change-log" id="change-log-btn">
            CHANGE LOG
          </button>
        </div>
      </div>
    </header>

    <!-- Sidebar -->
    <nav id="sidebar">
      <div class="sidebar-header" id="sidebar-tabs">
        <button class="sidebar-tab-btn active" data-source="truyvan">TRUY VẤN</button>
        <button class="sidebar-tab-btn" data-source="feedback">FEEDBACK</button>
      </div>
      <div class="sidebar-content">
        <div id="dynamic-filters-container"></div>
      </div>
    </nav>

    <!-- Main Content -->
    <main id="main-content">
      <!-- Sub Header -->
      <div id="sub-header">
        <div class="sub-header-box" id="xmtt-box">
          <button class="expand-btn" data-target="xmtt-box">⤢</button>
          <div id="xmtt-result" class="box-content">
            <div class="xmtt-column" id="xmtt-ib-column">
              <h5>XMTT IB</h5>
              <div id="xmtt-ib-content"><p>...</p></div>
            </div>
            <div class="xmtt-column" id="xmtt-ecom-column">
              <h5>XMTT ECOM</h5>
              <div id="xmtt-ecom-content"><p>...</p></div>
            </div>
          </div>
        </div>
        <div class="sub-header-box" id="notes-box">
          <button class="expand-btn" data-target="notes-box">⤢</button>
          <div id="notes-result" class="box-content">
            <p>Thông báo và lưu ý sẽ hiển thị ở đây</p>
          </div>
        </div>
      </div>

      <!-- Body Content (PDF Viewer) -->
      <div id="body-proper">
        <iframe
          id="pdf-viewer"
          src=""
          style="width: 100%; height: 100%; border: none"
        ></iframe>
      </div>
    </main>

    <div id="custom-popup" class="popup-container hidden">
      <button id="popup-close-btn">✖</button>
      <div id="popup-content"></div>
    </div>

    <div id="overlay"></div>
    <div id="toast-container"></div>

    <script src="ubank-flowchart.js" defer></script>
    <script src="ubank-fb-flowchart.js" defer></script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        if (typeof window.ubankFlowchartData === "undefined" || typeof window.ubankFlowchartDataFeedback === "undefined") {
          alert("Lỗi: Không thể tải dữ liệu điều kiện cho UBANK. Vui lòng kiểm tra file ubank-flowchart.js và ubank-fb-flowchart.js.");
          return;
        }

        const dynamicFiltersContainer = document.getElementById("dynamic-filters-container");
        const notesResult = document.getElementById("notes-result");
        const pdfViewer = document.getElementById("pdf-viewer");
        const sidebarToggle = document.getElementById("sidebar-toggle");
        const body = document.body;
        const headerSearch = document.getElementById("header-search");
        const searchResultsContainer = document.getElementById("search-results-container");
        const popup = document.getElementById("custom-popup");
        const popupContent = document.getElementById("popup-content");
        const popupCloseBtn = document.getElementById("popup-close-btn");
        const sidebar = document.getElementById("sidebar");

        const FOLDER_MAPS = {
          truyvan: { 1: "THONG_TIN_CHUNG", 2: "THONG_TIN_SAN_PHAM", 3: "DANG_KY_VAY", 4: "GIAI_NGAN", 5: "KENH_THANH_TOAN", 6: "THANH_TOAN_CIC" },
          feedback: { 1: "GOP_Y_TICH_CUC", 2: "GOP_Y_TIEU_CUC" }
        };
        const LEVEL_LABELS = {
          truyvan: { 1: "Chọn vấn đề:", 2: "Chọn chi tiết:", 3: "Chọn loại:", 4: "Chọn kênh:", 5: "Chọn loại đầu vào:" },
          feedback: { 1: "Chọn loại góp ý:", 2: "Chọn chi tiết:" }
        };
        
        const state = {
            activeData: null,
            flattenedData: [],
            activeSourceName: 'truyvan',
        };

        const dataSources = {
            truyvan: window.ubankFlowchartData,
            feedback: window.ubankFlowchartDataFeedback,
        };

        const isObject = (value) => typeof value === "object" && value !== null;
        const isLeaf = (node) => isObject(node) && node.pdf !== undefined;
        const removeAccents = (str) => str ? str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/đ/g, "d").replace(/Đ/g, "D") : "";

        function flattenFlowchart(node, path = [], breadcrumb = []) {
          Object.keys(node).forEach((key) => {
            const newPath = [...path, key];
            const newBreadcrumb = [...breadcrumb, key.replace(/^\d+\.\s*/, "")];
            const childNode = node[key];
            if (isLeaf(childNode)) {
              const displayText = childNode.displayName || newBreadcrumb.join(" > ");
              state.flattenedData.push({
                path: newPath,
                pdfName: childNode.pdf || "",
                displayText: displayText,
                normalizedDisplayText: removeAccents(displayText.toLowerCase()),
                normalizedPdfName: removeAccents((childNode.pdf || "").toLowerCase()),
              });
            } else if (isObject(childNode)) {
              flattenFlowchart(childNode, newPath, newBreadcrumb);
            }
          });
        }
        
        function switchDataSource(sourceName) {
            if (!dataSources[sourceName]) return;
            state.activeSourceName = sourceName;
            state.activeData = dataSources[sourceName];
            document.querySelectorAll('.sidebar-tab-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.source === sourceName));
            state.flattenedData = [];
            flattenFlowchart(state.activeData);
            createFirstLevelDropdown();
            resetResults();
            history.pushState({ source: sourceName }, "", `${window.location.pathname}?source=${sourceName}`);
        }

        function initialize() {
          setupEventListeners();
          const sourceParam = new URLSearchParams(window.location.search).get('source') || 'truyvan';
          switchDataSource(sourceParam);
          // Try to restore from URL first, then fall back to sessionStorage
          if (!restoreStateFromURL()) {
            restoreStateFromSession();
          }
        }

        function saveStateToURL(path) {
            const jsonPath = JSON.stringify(path);
            const encodedPath = btoa(encodeURIComponent(jsonPath));
            history.pushState({ path, source: state.activeSourceName }, "", `${window.location.pathname}?source=${state.activeSourceName}#${encodedPath}`);
            // Also save to sessionStorage as a backup
            sessionStorage.setItem('flowchartState', jsonPath);
        }

        function restoreStateFromURL() {
            if (window.location.hash.length > 1) {
                const encodedPath = window.location.hash.substring(1);
                try {
                    const jsonPath = decodeURIComponent(atob(encodedPath));
                    const path = JSON.parse(jsonPath);
                    if (Array.isArray(path)) {
                        applySearchResult(path, false);
                        // Also save to session storage in case it came from a direct link
                        sessionStorage.setItem('flowchartState', jsonPath);
                        return true; // Indicate success
                    }
                } catch (e) {
                    console.error("Failed to parse state from hash.", e);
                    return false; // Indicate failure
                }
            }
            return false; // No hash found
        }
        
        function restoreStateFromSession() {
          const jsonPath = sessionStorage.getItem('flowchartState');
          if (jsonPath) {
            try {
              const path = JSON.parse(jsonPath);
              if (Array.isArray(path)) {
                console.log('Restoring state from session storage.');
                // Restore and also update URL hash to keep them in sync
                applySearchResult(path, true); 
              }
            } catch(e) {
              console.error('Failed to restore state from session storage.', e);
            }
          }
        }

        function searchFlowchartData(query) {
          if (!query) return [];
          const normalizedQuery = removeAccents(query.toLowerCase());
          return state.flattenedData.filter(item => 
            item.normalizedDisplayText.includes(normalizedQuery) || 
            item.normalizedPdfName.includes(normalizedQuery)
          );
        }

        function displaySearchResults(results) {
          searchResultsContainer.innerHTML = "";
          if (!results.length) {
            searchResultsContainer.classList.remove("show");
            return;
          }
          results.slice(0, 10).forEach(result => {
            const item = document.createElement("div");
            item.className = "search-result-item";
            item.textContent = result.displayText;
            item.dataset.path = JSON.stringify(result.path);
            searchResultsContainer.appendChild(item);
          });
          searchResultsContainer.classList.add("show");
        }

        function applySearchResult(path, shouldSaveState = true) {
          removeDropdowns(1);
          let currentDataNode = state.activeData;
          path.forEach((key, index) => {
            if (!currentDataNode?.[key]) return;
            const level = index + 1;
            createDropdown(Object.keys(currentDataNode), level, currentDataNode);
            const select = dynamicFiltersContainer.querySelector(`select[data-level="${level}"]`);
            if (select) {
              select.value = key;
              currentDataNode = currentDataNode[key];
            }
          });
          if (isLeaf(currentDataNode)) {
            displayResult(currentDataNode);
            if (shouldSaveState) saveStateToURL(path);
          }
          searchResultsContainer.classList.remove("show");
          headerSearch.value = "";
          headerSearch.blur();
        }

        function createFirstLevelDropdown() {
          dynamicFiltersContainer.innerHTML = "";
          createDropdown(Object.keys(state.activeData), 1, state.activeData);
        }

        function createDropdown(options, level, dataNode) {
          const filterGroup = document.createElement("div");
          filterGroup.className = "filter-group";
          const label = document.createElement("label");
          label.className = "filter-label";
          label.textContent = (LEVEL_LABELS[state.activeSourceName]?.[level]) || `Cấp ${level}:`;
          filterGroup.appendChild(label);
          const select = document.createElement("select");
          select.className = "filter-select";
          select.dataset.level = level;
          select.innerHTML = '<option value="">-- Chọn --</option>';
          options.forEach(text => {
            const option = document.createElement("option");
            option.value = text;
            option.textContent = text;
            select.appendChild(option);
          });
          select.addEventListener("change", (e) => handleSelection(e, level, dataNode));
          filterGroup.appendChild(select);
          dynamicFiltersContainer.appendChild(filterGroup);
        }

        function repositionPopup() {
          if (popup.classList.contains("hidden")) {
            return;
          }
          const subHeaderRect = document.getElementById("sub-header").getBoundingClientRect();
          const mainHeaderHeight = document.getElementById("main-header").offsetHeight;
          const sidebarWidth = sidebar.offsetWidth;
          const leftOffset = 5;
          const rightOffset = 20;
          const totalHorizontalMargin = leftOffset + rightOffset;
          popup.style.top = mainHeaderHeight + "px";
          popup.style.left = sidebarWidth + leftOffset + "px";
          popup.style.width = `calc(100vw - ${sidebarWidth}px - ${totalHorizontalMargin}px)`;
          popup.style.height = subHeaderRect.height + "px";
        }

        function openPopup(targetBoxId) {
          const sourceBox = document.getElementById(targetBoxId);
          const sourceContent = sourceBox.querySelector(".box-content");
          if (!sourceBox || !sourceContent) {
            console.error("Popup source elements not found!");
            return;
          }
          popupContent.innerHTML = "";
          const clonedContent = sourceContent.cloneNode(true);
          popupContent.appendChild(clonedContent);
          popup.classList.remove("hidden");
          repositionPopup();
        }

        function closePopup() {
          popup.classList.add("hidden");
          setTimeout(() => {
            popupContent.innerHTML = "";
          }, 300);
        }
        
        function handleSelection(event, level, parentDataNode) {
          const selectedKey = event.target.value;
          removeDropdowns(level + 1);
          resetResults();
          if (!selectedKey) {
            history.pushState({source: state.activeSourceName}, "", `${window.location.pathname}?source=${state.activeSourceName}`);
            return;
          }
          const selectedNode = parentDataNode[selectedKey];
          if (isLeaf(selectedNode)) {
            displayResult(selectedNode);
            const path = Array.from(document.querySelectorAll(".filter-select")).map(s => s.value).filter(Boolean);
            saveStateToURL(path);
          } else if (isObject(selectedNode)) {
            createDropdown(Object.keys(selectedNode), level + 1, selectedNode);
          }
        }

        function setupEventListeners() {
          document.getElementById('sidebar-tabs').addEventListener('click', (e) => {
            const source = e.target.dataset.source;
            if (e.target.matches('.sidebar-tab-btn') && source !== state.activeSourceName) {
                switchDataSource(source);
            }
          });
          sidebarToggle.addEventListener("click", () => {
            body.classList.toggle("sidebar-collapsed");
            setTimeout(repositionPopup, 300);
          });
          headerSearch.addEventListener("input", (e) => displaySearchResults(searchFlowchartData(e.target.value)));
          headerSearch.addEventListener("focus", (e) => {
            if(e.target.value) displaySearchResults(searchFlowchartData(e.target.value));
          });
          searchResultsContainer.addEventListener("mousedown", (e) => {
            if (e.target.dataset.path) applySearchResult(JSON.parse(e.target.dataset.path));
          });
          document.addEventListener("click", (e) => {
            if (!headerSearch.contains(e.target) && !searchResultsContainer.contains(e.target)) {
              searchResultsContainer.classList.remove("show");
            }
          });
          window.addEventListener("popstate", () => {
            const sourceParam = new URLSearchParams(window.location.search).get('source') || 'truyvan';
            if(sourceParam !== state.activeSourceName) switchDataSource(sourceParam);
            restoreStateFromURL();
          });

          document.querySelectorAll(".expand-btn").forEach((btn) => {
            btn.addEventListener("click", () => {
              openPopup(btn.dataset.target);
            });
          });

          popupCloseBtn.addEventListener("click", closePopup);

          window.addEventListener("resize", repositionPopup);

          document.querySelector('.header-tabs').addEventListener('click', (e) => {
            if (e.target.classList.contains('pdf-link-btn')) {
              const pdfName = e.target.getAttribute('data-pdf');
              if (pdfName) {
                pdfViewer.src = `./pdf-header/${pdfName}`;
                // Reset other UI elements for clarity
                resetResults();
                removeDropdowns(1);
                history.pushState({ source: state.activeSourceName }, "", `${window.location.pathname}?source=${state.activeSourceName}`);
              }
            }
          });
        }

        function displayResult(resultObject) {
          const xmttIbContent = document.getElementById("xmtt-ib-content");
          const xmttEcomContent = document.getElementById("xmtt-ecom-content");
          xmttIbContent.innerHTML = resultObject.xmttib ? `<p>${resultObject.xmttib}</p>` : "<p>...</p>";
          if(xmttEcomContent) xmttEcomContent.innerHTML = resultObject.xmttecom ? `<p>${resultObject.xmttecom}</p>` : "<p>...</p>";
          if (resultObject.xmtt) {
            xmttIbContent.innerHTML = `<p>${resultObject.xmtt}</p>`;
            if(xmttEcomContent) xmttEcomContent.innerHTML = `<p>${resultObject.xmtt}</p>`;
          }
          notesResult.innerHTML = resultObject.note ? `<p>${resultObject.note}</p>` : "<p>Không có lưu ý.</p>";

          if (resultObject.pdf) {
            const firstLevelSelect = dynamicFiltersContainer.querySelector('select[data-level="1"]');
            const categoryIndexMatch = firstLevelSelect?.value.match(/^(\d+)/);
            const folderMap = FOLDER_MAPS[state.activeSourceName];
            const folderName = (categoryIndexMatch && folderMap) ? folderMap[categoryIndexMatch[1]] : null;
            const baseFolder = state.activeSourceName === 'feedback' ? 'pdfile-ubank-fb' : 'pdfile-ubank';
            
            pdfViewer.src = folderName ? `./${baseFolder}/${folderName}/${resultObject.pdf}` : `./${baseFolder}/${resultObject.pdf}`;
          } else {
            pdfViewer.src = "";
          }
        }

        function resetResults() {
          document.getElementById("xmtt-ib-content").innerHTML = "<p>...</p>";
          const ecomContent = document.getElementById("xmtt-ecom-content");
          if(ecomContent) ecomContent.innerHTML = "<p>...</p>";
          notesResult.innerHTML = "<p>Thông báo và lưu ý sẽ hiển thị ở đây</p>";
          pdfViewer.src = "";
        }

        function removeDropdowns(startLevel) {
          dynamicFiltersContainer.querySelectorAll(".filter-group").forEach((group) => {
            const select = group.querySelector("select");
            if (parseInt(select.dataset.level) >= startLevel) group.remove();
          });
        }

        initialize();
      });
    </script>
  </body>
</html>
