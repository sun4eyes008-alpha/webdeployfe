<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <title>H·ªá Th·ªëng L·ªçc QC SP - Offline</title>
    <script src="xlsx.full.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <div class="container">
        <h2>Tr√¨nh Qu·∫£n L√Ω D·ªØ Li·ªáu QC</h2>

        <div class="filter-grid">
            <div class="box">
                <label>üìÅ CH·ªåN FILE</label>
                <input type="file" id="file-input" accept=".xlsx, .xls, .csv" />
            </div>
            <div class="box">
                <label>üë• TEAM</label>
                <div id="team-list" class="scroll-list"></div>
            </div>
            <div class="box">
                <label>üë§ USER</label>
                <div id="user-list" class="scroll-list"></div>
            </div>
            <div class="box">
                <label>üìç CH·∫§M</label>
                <div id="cham-list" class="scroll-list"></div>
            </div>
            <div class="box">
                <label>‚úÖ QC SP</label>
                <div id="qc-list" class="scroll-list"></div>
            </div>
        </div>

        <div class="info-bar">
            <span id="stat">Vui l√≤ng ch·ªçn file...</span>
            <div class="btn-group">
                <button class="btn-select" onclick="openModal()">Ch·ªçn</button>
                <button class="btn-reset" onclick="resetAll()">X√≥a l·ªçc</button>
            </div>
        </div>

        <div class="table-area">
            <table id="data-table">
                <thead id="h-node"></thead>
                <tbody id="b-node"></tbody>
            </table>
        </div>
    </div>

    <div id="qcModal" class="modal">
        <div class="modal-content">
            <h3>Ch·ªçn User QC</h3>
            <select id="qc-user-select" style="width: 100%; padding: 10px; margin-bottom: 15px;"></select>
            <button class="btn-submit" onclick="submitQC()">X√°c nh·∫≠n & L∆∞u</button>
            <button onclick="closeModal('qcModal')"
                style="margin-top:10px; background:none; border:none; color:grey; cursor:pointer; display:block; width:100%;">H·ªßy
                b·ªè</button>
        </div>
    </div>

    <div id="resultModal" class="modal">
        <div class="modal-content">
            <h3 style="color: #28a745;">D·ªØ li·ªáu v·ª´a c·∫≠p nh·∫≠t</h3>
            <div class="result-scroll">
                <table id="result-table">
                    <thead id="rh-node"></thead>
                    <tbody id="rb-node"></tbody>
                </table>
            </div>
            <div class="btn-group-popup">
                <button class="btn-open-tool" onclick="openTool()">Open Tool</button>
                <button class="btn-close-result" onclick="closeModal('resultModal')">ƒê√≥ng Popup</button>
            </div>
        </div>
    </div>

    <script>
        let db = [];
        let cols = [];
        let sel = { Team: new Set(), USER: new Set(), "Ch·∫•m": new Set(), "QC SP": new Set() };
        let originalFileName = "Data_QC.xlsx";

        const listQC = ["em.ha", "diem.nguyen", "van.nguyen", "huong.pham.13", "thanh.nguyen.95", "anh.nguyen.111", "phuoc.vo.2", "diem.dang"];

        document.getElementById('file-input').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;
            originalFileName = file.name;

            const rd = new FileReader();
            rd.onload = function (ex) {
                const data = new Uint8Array(ex.target.result);
                const wb = XLSX.read(data, { type: 'array', cellDates: true });
                const ws = wb.Sheets[wb.SheetNames[0]];
                db = XLSX.utils.sheet_to_json(ws, { defval: "" });

                if (db.length > 0) {
                    cols = Object.keys(db[0]);
                    db.forEach(row => {
                        for (let key in row) {
                            if (row[key] instanceof Date) {
                                const d = row[key];
                                row[key] = `${String(d.getDate()).padStart(2, '0')}/${String(d.getMonth() + 1).padStart(2, '0')}/${d.getFullYear()}`;
                            }
                        }
                    });
                    resetAll();
                    sel["QC SP"].add("0");
                    refresh();
                }
            };
            rd.readAsArrayBuffer(file);
        });

        function refresh() {
            updateList('team-list', 'Team', ['USER', 'Ch·∫•m', 'QC SP']);
            updateList('user-list', 'USER', ['Team', 'Ch·∫•m', 'QC SP']);
            updateList('cham-list', 'Ch·∫•m', ['Team', 'USER', 'QC SP']);
            updateList('qc-list', 'QC SP', ['Team', 'USER', 'Ch·∫•m']);
            showTable();
        }

        function updateList(id, target, others) {
            const avail = [...new Set(db.filter(row => {
                return others.every(key => sel[key].size === 0 || sel[key].has(String(row[key])));
            }).map(row => String(row[target])))].sort();

            const dom = document.getElementById(id);
            dom.innerHTML = avail.map(v => `
            <label class="item">
                <input type="checkbox" ${sel[target].has(v) ? 'checked' : ''} onchange="toggle('${target}','${v}')"> ${v === "" ? "(Tr·ªëng)" : v}
            </label>
        `).join('');
        }

        function toggle(key, val) {
            sel[key].has(val) ? sel[key].delete(val) : sel[key].add(val);
            refresh();
        }

        function showTable() {
            const filtered = db.filter(row => {
                return Object.keys(sel).every(key => sel[key].size === 0 || sel[key].has(String(row[key])));
            });

            // C√°c c·ªôt c·∫ßn lo·∫°i b·ªè kh·ªèi hi·ªÉn th·ªã (chuy·ªÉn v·ªÅ lowercase ƒë·ªÉ so s√°nh)
            const excludeDisplayCols = ['th·ªèa ƒëi·ªÅu ki·ªán', 'ƒë·∫øm data', 'ch·∫•m', 'ng√†y l·∫•y data', 'date sp1'];
            const displayCols = cols.filter(c => !excludeDisplayCols.includes(c.toLowerCase().trim()));

            document.getElementById('stat').innerText = `K·∫øt qu·∫£: ${filtered.length} d√≤ng`;
            document.getElementById('h-node').innerHTML = `<tr>${displayCols.map(c => `<th>${c}</th>`).join('')}</tr>`;
            document.getElementById('b-node').innerHTML = filtered.map(row => `
            <tr>${displayCols.map(c => {
                const isZero = (row[c] === 0 || row[c] === "0" || row[c] === "");
                const cls = (c === 'QC SP' && !isZero) ? 'class="bad-qc"' : '';
                return `<td ${cls}>${isZero ? "0" : row[c]}</td>`;
            }).join('')}</tr>
        `).join('');
        }

        function resetAll() {
            Object.keys(sel).forEach(key => sel[key].clear());
            refresh();
        }

        function openModal() {
            const select = document.getElementById('qc-user-select');
            select.innerHTML = listQC.map(user => `<option value="${user}">${user}</option>`).join('');
            document.getElementById('qcModal').style.display = 'block';
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        function submitQC() {
            const selectedUser = document.getElementById('qc-user-select').value;
            const currentFiltered = db.filter(row => {
                return Object.keys(sel).every(key => sel[key].size === 0 || sel[key].has(String(row[key])));
            });

            let updatedCount = 0;
            currentFiltered.forEach(row => {
                if (String(row["QC SP"]) === "0" || row["QC SP"] === 0 || row["QC SP"] === "") {
                    row["QC SP"] = selectedUser;
                    updatedCount++;
                }
            });

            if (updatedCount > 0) {
                sel["QC SP"].add(selectedUser);

                // 1. Hi·ªÉn th·ªã Popup k·∫øt qu·∫£
                showResultPopup(currentFiltered);

                // 2. L∆∞u file full
                saveFullFile();

                closeModal('qcModal');
                refresh();
            } else {
                alert("Kh√¥ng t√¨m th·∫•y d√≤ng gi√° tr·ªã '0' ƒë·ªÉ c·∫≠p nh·∫≠t.");
            }
        }

        function showResultPopup(data) {
            // C√°c c·ªôt c·∫ßn lo·∫°i b·ªè kh·ªèi hi·ªÉn th·ªã (chuy·ªÉn v·ªÅ lowercase ƒë·ªÉ so s√°nh)
            const excludeDisplayCols = ['th·ªèa ƒëi·ªÅu ki·ªán', 'ƒë·∫øm data', 'ch·∫•m', 'ng√†y l·∫•y data', 'date sp1'];
            const displayCols = cols.filter(c => !excludeDisplayCols.includes(c.toLowerCase().trim()));

            document.getElementById('rh-node').innerHTML = `<tr>${displayCols.map(c => `<th>${c}</th>`).join('')}</tr>`;
            document.getElementById('rb-node').innerHTML = data.map(row => `
            <tr>${displayCols.map(c => `<td>${row[c] || "0"}</td>`).join('')}</tr>
        `).join('');
            document.getElementById('resultModal').style.display = 'block';
        }

        function saveFullFile() {
            const ws = XLSX.utils.json_to_sheet(db);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Updated_Data");
            XLSX.writeFile(wb, "Updated_" + originalFileName);
        }

        function openTool() {
            // L·∫•y d·ªØ li·ªáu hi·ªán t·∫°i trong popup (currentFiltered ƒë√£ ƒë∆∞·ª£c l∆∞u)
            const currentFiltered = db.filter(row => {
                return Object.keys(sel).every(key => sel[key].size === 0 || sel[key].has(String(row[key])));
            });

            // L∆∞u d·ªØ li·ªáu v√†o sessionStorage ƒë·ªÉ truy·ªÅn sang trang m·ªõi
            sessionStorage.setItem('toolcheckData', JSON.stringify(currentFiltered));
            sessionStorage.setItem('toolcheckCols', JSON.stringify(cols));

            // M·ªü trang toolcheck.html trong tab m·ªõi
            window.open('toolcheck.html', '_blank');
        }

        window.onclick = function (event) {
            if (event.target.className === 'modal') {
                event.target.style.display = 'none';
            }
        }
    </script>

</body>

</html>